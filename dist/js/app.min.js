"use strict";

angular.module("app", [ "app.core", "app.flickr", "ui.router", "ngSanitize", "ngTouch", "ngResource", "infinite-scroll", "angularFileUpload", "ngImgCrop" ]).run([ "$rootScope", "$state", "$stateParams", "$window", "$location", "$timeout", function($rootScope, $state, $stateParams) {
    $rootScope.flickrApiKey = "5202f8e46861f39f55bedfa2374a41d8", $rootScope.apiUrlUpload = "http://liftoff.local/api/angular-media/", 
    $rootScope.apiUrlBrowse = "http://liftoff.local/api/angular-media/", $rootScope.appUrl = "", 
    $rootScope.files = [], $rootScope.multiple = !1, $rootScope.$state = $state, $rootScope.$stateParams = $stateParams, 
    $rootScope.$on("$stateChangeSuccess", function() {}), $rootScope.goSubRoute = function(baseRoute, subRoute, baseName) {
        baseName = void 0 == baseName ? "base" : baseName;
        var stateName = baseRoute + "." + subRoute;
        try {
            var state = $state.get(stateName);
            if (void 0 == state || null == state) throw "myException";
        } catch (e) {
            stateName = baseRoute + "." + baseName;
        }
        $state.go(stateName);
    };
} ]).config([ "$locationProvider", "$stateProvider", "$urlRouterProvider", function($locationProvider, $stateProvider) {} ]), 
angular.module("app.core", [ "ui.router", "angularFileUpload" ]).config([ "$stateProvider", "$urlRouterProvider", function($stateProvider) {
    $stateProvider.state("base", {}).state("modal", {
        templateUrl: appUrl + "views/modal.html",
        onEnter: function($state) {
            $(document).on("keyup", function(e) {
                27 == e.keyCode && ($(document).off("keyup"), $state.go("base"));
            }), $(document).on("click", ".modal-backdrop, .modal-holder", function() {
                $state.go("base");
            }), $(document).on("click", ".modal-box, .modal-box *", function(e) {
                e.stopPropagation();
            });
        },
        "abstract": !0
    }).state("modal.upload", {
        url: "/upload",
        templateUrl: appUrl + "views/upload.html",
        controller: "upload"
    }).state("modal.browse", {
        url: "/browse/:person",
        templateUrl: appUrl + "views/browse.html",
        controller: "browse"
    });
} ]).controller("browse", function($scope, $rootScope, $state, $stateParams, CoreBrowser, CoreFile) {
    $scope.filters = {
        page: 1,
        person: $stateParams.person
    }, console.log($stateParams), $scope.selected = [], $scope.items = [], $scope.loadItems = function(push) {
        CoreBrowser.query($scope.filters, function(data) {
            void 0 !== push && 1 == push ? Array.prototype.push.apply($scope.items, data) : $scope.items = data, 
            console.log($scope.items);
        });
    }, $scope.updateFilters = function() {
        $scope.filters.page = 1, console.log("prehi"), $scope.items = $scope.loadItems(), 
        console.log("hi"), console.log($scope.items);
    }, $scope.updateFilters(), $scope.updateActive = function(item) {
        void 0 != item && ($rootScope.multiple && item.active ? (item.active = !1, angular.forEach($scope.selected, function(activeItem, key) {
            activeItem.id == item.id && $scope.selected.splice(key, 1);
        })) : ($scope.active = item, $rootScope.multiple ? (item.active = !0, $scope.active = item) : angular.forEach($scope.items, function(activeItem, key) {
            $scope.items[key].active = activeItem.id == item.id ? !0 : !1;
        }), $rootScope.multiple ? $scope.selected.push(item) : $scope.selected = [ item ], 
        CoreFile.load({
            fid: item.fid
        }, function(data) {
            $scope.active = data, console.log(data);
        })));
    }, $scope.submit = function() {
        console.log($scope.selected), Array.prototype.push.apply($rootScope.files, $scope.selected), 
        $state.go("base");
    }, $scope.addItems = function() {};
}).controller("upload", function($scope, $rootScope, $state, $stateParams, FileUploader) {
    $scope.uploading = !1, $scope.selected = [];
    var uploader = $scope.uploader = new FileUploader({
        url: $rootScope.apiUrlUpload + "upload",
        autoUpload: !0
    });
    uploader.onSuccessItem = function(fileItem, response, status, headers) {
        console.info("onSuccessItem", fileItem, response, status, headers), $scope.selected.push(response);
    }, uploader.onBeforeUploadItem = function(item) {
        console.info("onBeforeUploadItem", item), $scope.uploading = !0;
    }, uploader.onCompleteAll = function() {
        console.info("onCompleteAll"), $scope.uploading = !1;
    }, $scope.submit = function($event) {
        console.log($scope.selected), Array.prototype.push.apply($rootScope.files, $scope.selected), 
        $scope.selected = [], $state.go("base"), $event.preventDefault();
    };
}), angular.module("app.flickr", [ "ui.router", "ngResource" ]).config([ "$stateProvider", "$urlRouterProvider", function($stateProvider) {
    $stateProvider.state("modal.flickr", {
        url: "/flickr",
        templateUrl: appUrl + "views/flickr.html",
        controller: function($scope, $rootScope, $state, Flickr, CoreFile) {
            $scope.filters = {
                method: "flickr.photos.search",
                tags: "baltimore",
                license: "4,5",
                page: 1
            }, $scope.licenses = Flickr.load({
                method: "flickr.photos.licenses.getInfo"
            }), $scope.selected = [], $scope.active = void 0, $scope.loadItems = function(push) {
                Flickr.load($scope.filters, function(data) {
                    var structured = [];
                    angular.forEach(data.photos.photo, function(item) {
                        structured.push({
                            thumbUrl: "https://farm" + item.farm + ".staticflickr.com/" + item.server + "/" + item.id + "_" + item.secret + "_q.jpg",
                            name: item.title,
                            id: item.id,
                            secret: item.secret,
                            farm: item.farm,
                            server: item.server
                        });
                    }), void 0 !== push && 1 == push ? ($scope.items = void 0 != $scope.items ? $scope.items : [], 
                    Array.prototype.push.apply($scope.items, structured)) : $scope.items = structured;
                });
            }, $scope.updateFilters = function() {
                $scope.filters.page = 1, $scope.items = $scope.loadItems();
            }, $scope.updateFilters(), $scope.updateActive = function(item) {
                void 0 != item && ($rootScope.multiple && item.active ? (item.active = !1, angular.forEach($scope.selected, function(activeItem, key) {
                    activeItem.id == item.id && $scope.selected.splice(key, 1);
                }), console.log($scope.active)) : ($scope.active = item, $rootScope.multiple ? item.active = !0 : angular.forEach($scope.items, function(activeItem, key) {
                    $scope.items[key].active = activeItem.id == item.id ? !0 : !1;
                }), Flickr.load({
                    method: "flickr.photos.getInfo",
                    photo_id: item.id,
                    secret: item.secret
                }, function(data) {
                    $scope.active.previewUrl = "https://farm" + item.farm + ".staticflickr.com/" + item.server + "/" + item.id + "_" + item.secret + "_m.jpg", 
                    $scope.active.url = "https://farm" + item.farm + ".staticflickr.com/" + item.server + "/" + item.id + "_" + item.secret + ".jpg", 
                    $scope.active.name = data.photo.title._content, $scope.active.filename = $scope.active.name + ".jpg", 
                    $scope.active.source = data.photo.urls.url[0]._content, $scope.active.user = data.photo.owner.realname ? data.photo.owner.realname : data.photo.owner.username, 
                    $scope.active.userLink = "https://www.flickr.com/people/" + data.photo.owner.nsid, 
                    $scope.active.title = $scope.active.user + " on Flickr", $scope.active.license = $scope.licenses.licenses.license[data.photo.license], 
                    $rootScope.multiple ? $scope.selected.push($scope.active) : $scope.selected = [ $scope.active ];
                }), Flickr.load({
                    method: "flickr.photos.getSizes",
                    photo_id: item.id,
                    secret: item.secret
                }, function(data) {
                    var size = data.sizes.size.pop();
                    $scope.active.width = size.width, $scope.active.height = size.height;
                })));
            }, $scope.submit = function($event) {
                $scope.queue = {
                    total: $scope.selected.length,
                    completed: 0,
                    files: []
                }, angular.forEach($scope.selected, function(item, key) {
                    var file = new CoreFile(item);
                    file.$save(function(data) {
                        $scope.queue.completed++, $scope.queue.files[key] = data, $scope.queue.progress = $scope.queue.completed / $scope.queue.total, 
                        $scope.queue.completed >= $scope.queue.total && (Array.prototype.push.apply($rootScope.files, $scope.queue.files), 
                        $scope.queue = void 0, $state.go("base"));
                    });
                }), $event.preventDefault();
            };
        }
    });
} ]), angular.module("app.flickr").factory("Flickr", function($resource, $rootScope) {
    return $resource("https://api.flickr.com/services/rest/", {
        api_key: $rootScope.flickrApiKey,
        format: "json",
        jsoncallback: "JSON_CALLBACK"
    }, {
        load: {
            method: "JSONP"
        }
    });
}), angular.module("app.core").factory("CoreBrowser", function($resource, $rootScope) {
    return $resource($rootScope.apiUrl + "browse/:person/:type/:name", {
        format: "json",
        type: "@type",
        name: "@name",
        person: "@person"
    }, {
        load: {
            method: "JSON"
        }
    });
}).factory("CoreFile", function($resource, $rootScope) {
    return $resource($rootScope.apiUrl + "file", {
        format: "json",
        fid: "@fid",
        filename: "@filename",
        name: "@name",
        title: "@title",
        alt: "@alt",
        license: "@license",
        source: "@source",
        url: "@url"
    }, {
        load: {
            method: "JSON"
        }
    });
}), angular.module("app.core").controller("thumbnails", function($scope, $rootScope, $state, $stateParams, FileUploader) {
    $scope.init = function(params) {
        $rootScope.apiUrl = void 0 != params.apiUrl ? params.apiUrl : "", $rootScope.multiple = void 0 != params.multiple ? params.multiple : !1, 
        $rootScope.files = void 0 != params.files ? params.files : [], console.log($rootScope), 
        console.log(params);
    };
    $scope.uploader = new FileUploader({
        url: $rootScope.apiUrlUpload + "upload",
        autoUpload: !0
    });
    $scope.remove = function(key) {
        console.log("remove"), $rootScope.files.splice(key, 1);
    };
});